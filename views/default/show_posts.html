{{extend 'layout.html'}}


<div id="target"></div>

<body class="cbp-spmenu-push">

<style>
    body {
        background-color: #f2f2f2
    }
</style>

<script id="template" type="text/ractive">

  <!--shows the sign in sign out buttons-->
  {{if auth.user_id is None:}}
            <h1>
            <div style = "float:left">
            {{=A('Back', _class='ghost_button', _href=URL('default', 'show_boards', args=[]))}}
            </div>
            <div style = "float:right" id="main_login">
            {{=A('Sign Up', _class='ghost_button', _href=URL('default', 'user', args=['register']))}}
            {{=A('Sign In', _class='ghost_button', _href=URL('default', 'user', args=['login']))}}
             <br><br>
            </div>
                <div style="clear: both;"></div>
            </h1>
  {{else:}}
    <div class = "buttons">

        <div style="display: inline-block; float:right;">
            {{=A('Logout', _class='ghost_button', _href=URL('default', 'user', args=['logout']))}}
        </div>

        {{=A('Back', _class='ghost_button', _href=URL('default', 'show_boards', args=[]))}}
        {{=A('Create Post', _class='ghost_button', _href=URL('default', 'add_posts', args=[post_category]))}}

    </div>
  {{pass}}
    <div class="dropdown">
        Sort By: <br>
      <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">
        {% #if sort_rated %}
            Highest Rating
        {% /if %}
        {% #if sort_recent %}
            Most Recent
        {% /if %}

      <span class="caret"></span></button>
      <ul class="dropdown-menu">
        <li class="hover_hand"><a on-click="loadposts:1">
            {% #if sort_rated %}
            ✔
            {% /if %}
            Highest Rating
        </a></li>
        <li class="hover_hand"><a on-click="loadposts:2">
            {% #if sort_recent %}
            ✔
            {% /if %}
            Most Recent
        </a></li>
      </ul>
    </div>

  {% #post_list %}
    <div class = "myboard" >
        <div class="boardtitle hover_hand" on-click="go_to_post:{%id%},{%category%}">
            {% title %}
        </div>
        <div class="boardbody">
            Average Rating:
            {% #star_dict[id]%}
                <i style = "color: #ffad33" class = "fa fa-star"></i>
            {% /star_dict %}


            {% #if half_star_dict[id] %}
                <span style=" margin-left: -4px;">
                <i style = "color: #ffad33" class = "fa fa-star-half-o"></i>
                </span>
            {% /if %}


            <span style=" margin-left: -4px;">
            {% #anti_star_dict[id]%}
                <i style = "color: #ffad33;" class = "fa fa-star-o"></i>
            {% /star_dict %}

            </span>
            ({% avg_rate %})
            <br>
            <br>
            Posted On: {% created_on %}
            <br>
            <br>
            {% #if user_id == {{=auth.user_id}} %}
                <a href="{{=URL('default', 'posts_edit')}}/{%id%}" class="fa fa-pencil fa-2x" ></a>
                <a href="{{=URL('default', 'delete_post')}}/{%id%}/{%category%}" class="fa fa-trash fa-2x" ></a>
            {% /if %}
        </div>
    </div>
  {% /post_list %}


  </script>




<script>
$(function() {

  // Ractive object
  var MAIN = new Ractive({
    el: '#target',
    template: '#template',
    delimiters: ['{%', '%}'],
    tripleDelimiters: ['{%%', '%%}'],
    data: {
        post_list: [],
        star_dict: {},
        anti_star_dict: {},
        half_star_dict: {},
        sort_rated: false,
        sort_recent: false,
        loading: false
    }
  });

  // Loads the initial list of posts.
  $.ajax("{{=URL('default', 'load_posts_recent', user_signature=True, args=post_category)}}",
          {
            method: 'POST',
            success: function (data) {
                MAIN.set('post_list', data['post_list']);
                MAIN.set('star_dict', data['star_dict']);
                MAIN.set('anti_star_dict', data['anti_star_dict']);

                MAIN.set('half_star_dict', data['half_star_dict']);


                MAIN.set('sort_recent', true);
                MAIN.set('sort_rated', false);
            }
          }
  );

    //loads the posts by rating or most recent depending on args
    MAIN.on("loadposts", function(e, num){
        if(num == 1) {
             $.ajax("{{=URL('default', 'load_posts_rating', user_signature=True, args=post_category)}}",
                      {
                        method: 'POST',
                        success: function (data) {
                            MAIN.set('post_list', data['post_list']);
                            MAIN.set('star_dict', data['star_dict']);
                            MAIN.set('anti_star_dict', data['anti_star_dict']);
                            MAIN.set('half_star_dict', data['half_star_dict']);
                            MAIN.set('loading', false);

                            MAIN.set('sort_recent', false);
                            MAIN.set('sort_rated', true);
                        }
                      }
              );

        }
        else if(num==2){
            $.ajax("{{=URL('default', 'load_posts_recent', user_signature=True, args=post_category)}}",
                      {
                        method: 'POST',
                        success: function (data) {
                            MAIN.set('post_list', data['post_list']);
                            MAIN.set('star_dict', data['star_dict']);
                            MAIN.set('anti_star_dict', data['anti_star_dict']);
                            MAIN.set('half_star_dict', data['half_star_dict']);
                            MAIN.set('loading', false);

                            MAIN.set('sort_recent', true);
                            MAIN.set('sort_rated', false);
                        }
                      }
              );
        }
    });

    //goes to the page for that post
    MAIN.on("go_to_post", function(e, post_id, category){
        window.location.href = '{{=URL('default', 'post_page')}}' + '/' + post_id + '/' + category;
    });

  // Called every 10s, checks for changes in posts and loads them
  function periodic_load() {
      var sort_recent = MAIN.get('sort_recent');
      var sort_rated = MAIN.get('sort_rated');
      if(sort_rated) {
             $.ajax("{{=URL('default', 'load_posts_rating', user_signature=True, args=post_category)}}",
                      {
                        method: 'POST',
                        success: function (data) {
                            MAIN.set('post_list', data['post_list']);
                            MAIN.set('star_dict', data['star_dict']);
                            MAIN.set('anti_star_dict', data['anti_star_dict']);
                            MAIN.set('loading', false);
                        }
                      }
              );

        }
        else if(sort_recent){
            $.ajax("{{=URL('default', 'load_posts_recent', user_signature=True, args=post_category)}}",
                      {
                        method: 'POST',
                        success: function (data) {
                            MAIN.set('post_list', data['post_list']);
                            MAIN.set('star_dict', data['star_dict']);
                            MAIN.set('anti_star_dict', data['anti_star_dict']);
                            MAIN.set('loading', false);
                        }
                      }
              );
        }
  }

  setInterval(periodic_load, 10000);

});
</script>

</body>






