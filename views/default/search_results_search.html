{{extend 'layout.html'}}


<div id="target"></div>

            <style>
        #suggestions {
            position: relative;
            /*padding: 20px;*/
        }
        .suggestions {
            margin-top: 5px;
            background: white;
            width: 250px;
        }
        .search_list {
            padding: 4px 6px 4px 6px;
            word-wrap: break-word;
        }
    </style>


<body class="cbp-spmenu-push">

<script id="template" type="text/ractive">

<!--shows the sign in sign out buttons-->
  <div class="header-bar">
        <h3>Posts</h3>
    </div>


       <div>
         {{=A('Back', _class='btn btn-primary', _href=URL('default', 'show_boards', args=[]))}}


  <form style="float:right" action="{{=URL('default', 'search_results_search')}}" method="post">
      <input type="text" id="keyword" name="keyword" autocomplete="off" style="width: 250px;" />
         <div style="position: absolute;" id="suggestions"
              class="suggestions">
      </div>

        <input class="btn btn-primary" type="submit" value="Search">

    </form>
 </div>

  {% #post_list %}
    <div class = "myboard" >
        <div class="boardtitle hover_hand" on-click="go_to_post:{%id%}">
            {% title %}
        </div>
        <div class="boardbody">
            Average Rating:
            {% #star_dict[id]%}
                <i style = "color: #ffad33" class = "fa fa-star"></i>
            {% /star_dict %}


            {% #if half_star_dict[id] %}
                <span style=" margin-left: -4px;">
                <i style = "color: #ffad33" class = "fa fa-star-half-o"></i>
                </span>
            {% /if %}


            <span style=" margin-left: -4px;">
            {% #anti_star_dict[id]%}
                <i style = "color: #ffad33;" class = "fa fa-star-o"></i>
            {% /star_dict %}

            </span>
            ({% avg_rate %})
            <br>
            <br>
            Posted On: {% created_on %}
            <br>
            <br>

            {% #if user_id == {{=auth.user_id}} %}
                <a href="{{=URL('default', 'posts_edit')}}/{%id%}" class="btn btn-info" >Edit</a>
                <a href="{{=URL('default', 'delete_post')}}/{%id%}/{%category%}" class="btn btn-danger" >Delete</a>
            {% /if %}
        </div>
    </div>
  {% /post_list %}


  </script>




<script>


$(function() {

  // Ractive object
  var MAIN = new Ractive({
    el: '#target',
    template: '#template',
    delimiters: ['{%', '%}'],
    tripleDelimiters: ['{%%', '%%}'],
    data: {
        post_list: [],
        star_dict: {},
        anti_star_dict: {},
        half_star_dict: {},
        sort_rated: false,
        sort_recent: false,
        loading: false
    }
  });

  $("#keyword").keyup(function () {
    ajax('{{=URL('default', 'post_selector')}}', ['keyword'], 'suggestions')
    });


  // Loads the initial list of posts.
  $.ajax("{{=URL('default', 'load_search_results', user_signature=True, args=search_text)}}",
          {
            method: 'POST',
            success: function (data) {
                MAIN.set('post_list', data['post_list']);
                MAIN.set('star_dict', data['star_dict']);
                MAIN.set('anti_star_dict', data['anti_star_dict']);

                MAIN.set('half_star_dict', data['half_star_dict']);


                MAIN.set('sort_recent', true);
                MAIN.set('sort_rated', false);
            }
          }
  );

    //loads the posts by rating or most recent depending on args
    MAIN.on("loadposts", function(e){

            $.ajax("{{=URL('default', 'load_posts_rating', user_signature=True, args=search_text)}}",
                    {
                        method: 'POST',
                        success: function (data) {
                            MAIN.set('post_list', data['post_list']);
                            MAIN.set('star_dict', data['star_dict']);
                            MAIN.set('anti_star_dict', data['anti_star_dict']);
                            MAIN.set('half_star_dict', data['half_star_dict']);
                            MAIN.set('loading', false);

                            MAIN.set('sort_recent', false);
                            MAIN.set('sort_rated', true);
                        }
                    }
            );
    });

    //goes to the page for that post
    MAIN.on("go_to_post", function(e, post_id, category){
        window.location.href = '{{=URL('default', 'post_page')}}' + '/' + post_id + '/' + category;
    });

  // Called every 10s, checks for changes in posts and loads them
  function periodic_load() {

  }

  setInterval(periodic_load, 10000);

});
</script>

</body>