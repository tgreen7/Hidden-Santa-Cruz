(dp1
S'output'
p2
S"<class 'sqlite3.IntegrityError'> foreign key constraint failed"
p3
sS'layer'
p4
S'C:\\Users\\Taoh\\Desktop\\git\\Project-cmps183\\web2py\\applications\\cmps183_project\\controllers/default.py'
p5
sS'code'
p6
S'# -*- coding: utf-8 -*-\n# this file is released under public domain and you can use without limitations\n\n#########################################################################\n## This is a sample controller\n## - index is the default action of any application\n## - user is required for authentication and authorization\n## - download is for downloading files uploaded in the db (does streaming)\n#########################################################################\n\ndef deleteboards():\n    db(db.board.id > 0).delete()\n\ndef deleteposts():\n    db(db.posts.id > 0).delete()\n\ndef deletereviews():\n    db(db.reviews.id>0).delete()\n\ndef map():\n    return dict(postlist = [])\n\ndef index():\n    redirect(URL(\'show_boards\'))\n    return dict(board_list = [])\n\ndef show_boards():\n    board_list = db(db.board).select()\n\n    # Code for search bar\n    search_form = FORM(INPUT(_id=\'keyword\', _name=\'keyword\', _onkeyup="ajax(\'callback\', [\'keyword\'], \'target\');"))\n    target_div = DIV(_id=\'target\', _class=\'searchlist\')\n\n    return dict(board_list=board_list, search_form=search_form, target_div=target_div)\n\ndef callback():\n     "an ajax callback that returns a <ul> of links to post pages"\n     query = db.posts.title.contains(request.vars.keyword)\n     posts = db(query).select(orderby=db.posts.title)\n     links = [(A(p.title, _href=URL(\'post_page\',args=[p.id, p.board])))\n              for p in posts]\n     return UL(*links)\n\n@auth.requires_login()\ndef add_board():\n    logger.info("My session is: %r" % session)\n    form = SQLFORM(db.board)\n    if form.process().accepted:\n        session.flash = T(\'the data was inserted\')\n        redirect(URL(\'show_boards\')) #might change to index\n    return dict(form=form)\n\ndef load_posts_rating():\n    post_board_id = request.args(0)\n    # print post_board_id\n    posts = db(db.posts.board == post_board_id).select(orderby=~db.posts.avg_rate)\n\n    star_dict = {}\n    anti_star_dict = {}\n    half_star_dict = {}\n\n    for post in posts:\n        if (post.avg_rate - int(post.avg_rate)) >= 0.5:\n            half_star_dict[post.id] = True\n            anti_star_dict[post.id] = range(0, int(4 - int(post.avg_rate)))\n        else:\n            anti_star_dict[post.id] = range(0, int(5 - int(post.avg_rate)))\n            half_star_dict[post.id] = False\n\n        star_dict[post.id] = range(0, int(post.avg_rate))\n\n    return response.json(dict(post_list=posts.as_list(), star_dict=star_dict, anti_star_dict=anti_star_dict, half_star_dict=half_star_dict))\n\ndef load_posts_recent():\n    post_board_id = request.args(0)\n    # print post_board_id\n    posts = db(db.posts.board == post_board_id).select(orderby=~db.posts.created_on)\n\n    star_dict = {}\n    anti_star_dict = {}\n    half_star_dict = {}\n\n    for post in posts:\n        if (post.avg_rate - int(post.avg_rate)) >= 0.5:\n            half_star_dict[post.id] = True\n            anti_star_dict[post.id] = range(0, int(4 - int(post.avg_rate)))\n        else:\n            anti_star_dict[post.id] = range(0, int(5 - int(post.avg_rate)))\n            half_star_dict[post.id] = False\n\n        star_dict[post.id] = range(0, int(post.avg_rate))\n\n\n    return response.json(dict(post_list=posts.as_list(), star_dict=star_dict, anti_star_dict=anti_star_dict, half_star_dict=half_star_dict))\n\ndef show_posts():\n    post_board = request.args(0)\n    # print "yes"\n    # print type(post_board)\n    # print type(db.posts.board)\n    # post_list = db(db.posts.board == \'art\').select()\n    post_list = db(db.posts).select()\n    # for post in post_list:\n        # print post.board\n        # print \'test\'\n    #     # update the average review\n    #     count = db(db.reviews.post == post.id).count()\n    #     if count == 0:\n    #         break\n    #\n    #     reviews = db(db.reviews.post == post.id).select()\n    #     total = 0\n    #\n    #     for i in reviews:\n    #         total += i.num_stars\n    #     dub = float(\'%.2f\' % (total / float(count)))\n    #     db.posts(post.id).update_record(avg_rate=dub)\n    #\n    # post_list = db(db.posts.board == post_board_id).select(orderby=~db.posts.avg_rate)\n    return dict(post_list=post_list, post_board_id=post_board)\n\n@auth.requires_login()\ndef add_posts():\n    logger.info("My session is: %r" % session)\n    form = SQLFORM(db.posts)\n\n    board = request.args(0)\n    print type(board)\n    print board\n\n    form.vars.board = str(request.args(0))\n    form.vars.user_id = auth.user_id\n\n    if form.process().accepted:\n        session.flash = T(\'the data was inserted\')\n        redirect(URL(\'default\',\'show_posts\', args=[board])) #might change to index\n    return dict(form=form)\n\n@auth.requires_login()\ndef posts_edit():\n    posts = db.posts(request.args(0))\n    if(auth.user_id != posts.user_id):\n         redirect(URL(\'default\', \'show_posts\', args=[posts.board]))\n         session.flash = T(\'Not permitted for this user\')\n    else:\n        form = SQLFORM(db.posts, record=posts, upload = URL(\'download\'))\n        if form.process().accepted:\n            session.flash = T(\'The data was edited\')\n            redirect(URL(\'default\', \'show_posts\', args=[posts.board]))\n        return dict(form=form)\n\n#delete post\n@auth.requires_login()\ndef delete_post():\n    post = db.posts(request.args(0))\n    if (auth.user_id != post.user_id):\n        redirect(URL(\'default\', \'show_posts\', args=request.args(1)))\n        session.flash = T(\'Not permitted for this user\')\n\n    else:\n        db(db.posts.id == post).delete()\n        redirect(URL(\'default\',\'show_posts\', args=request.args(1)))\n\n\ndef post_page():\n    post_id = request.args(0)\n    board = db.posts(post_id).board\n    post = db.posts[post_id]\n    title = post.title\n    body = post.body\n    reviews = db(db.reviews.post == post_id).select()\n    num_rev = db(db.reviews.post == post_id).count()\n    # print "numrev" + str(num_rev)\n\n    images = db(db.uploads.post == post_id).select()\n    return dict(post = post, reviews=reviews, num_rev=num_rev, title=title, body= body, images = images, board=board)\n\n# upload images\ndef upload_images():\n    import datetime\n    form = FORM(LABEL("File(s):"), INPUT(_name=\'up_files\', _type=\'file\', _multiple=\'\', requires=IS_NOT_EMPTY()),  BR(),INPUT(_type=\'submit\'))\n    if form.accepts(request.vars, formname="form"):\n        files = request.vars[\'up_files\']\n        if not isinstance(files, list):\n            files = [files]\n        for f in files:\n            print f.filename\n            up_file = db.uploads.up_file.store(f, f.filename)\n            i = db.uploads.insert(notes=request.vars.notes, up_file=up_file, filename=f.filename, post = request.args(0), up_date= datetime.datetime.now())\n            db.commit()\n        redirect(URL(\'post_page\',args=request.args(0)))\n    return dict(form=form)\n\n@auth.requires_login()\ndef add_review():\n    form = SQLFORM(db.reviews)\n    form.vars.post = request.args(0)\n    form.vars.user_id = auth.user_id\n    if form.process().accepted:\n        session.flash = T(\'the data was inserted\')\n        redirect(URL(\'default\',\'post_page\', args=request.args(0)))\n    return dict(form=form)\n\n\ndef load_reviews():\n    post_board_id = request.args(0)\n    rows = db(db.reviews.post == post_board_id).select()\n\n    def get_name(user_id):\n        test = db(db.auth_user.id == user_id).select()\n        firstname = ""\n        lastname = ""\n        for i in test:\n            firstname = i.first_name\n            lastname =  i.last_name\n        return firstname + " " + lastname\n\n    d = {r.id: {\'body\': r.body,\n                \'user_id\': r.user_id,\n                \'user\': get_name(r.user_id),\n                \'num_stars\':r.num_stars,\n                \'star_list\': range(0,r.num_stars),\n                \'anti_star_list\': range(0, 5-r.num_stars),\n                \'post_id\':r.post\n                }\n\n         for r in rows}\n    return response.json(dict(review_dict=d))\n\n@auth.requires_login()\ndef delete_review():\n    rev_id = request.vars.get("rev_id")\n    db(db.reviews.id == rev_id).delete()\n    redirect(URL(\'default\', \'post_page\', args= request.vars.get("post")))\n\n\n@auth.requires_login()\ndef edit_review():\n    rev_id = request.args(0)\n    post_id = request.args(1)\n    user_id = request.args(2)\n\n\n    if int(auth.user_id) != int(user_id):\n        session.flash = T(\'Not permitted for this user\')\n        redirect(URL(\'default\', \'post_page\', args=[post_id]))\n\n    form = SQLFORM(db.reviews, record=rev_id)\n\n    if form.process().accepted:\n        session.flash = T(\'The data was edited\')\n        redirect(URL(\'default\', \'post_page\', args=[post_id]))\n    return dict(form=form)\n\n\ndef user():\n    """\n    exposes:\n    http://..../[app]/default/user/login\n    http://..../[app]/default/user/logout\n    http://..../[app]/default/user/register\n    http://..../[app]/default/user/profile\n    http://..../[app]/default/user/retrieve_password\n    http://..../[app]/default/user/change_password\n    http://..../[app]/default/user/manage_users (requires membership in\n    http://..../[app]/default/user/bulk_register\n    use @auth.requires_login()\n        @auth.requires_membership(\'group name\')\n        @auth.requires_permission(\'read\',\'table name\',record_id)\n    to decorate functions that need access control\n    """\n    return dict(form=auth())\n\n\n@cache.action()\ndef download():\n    """\n    allows downloading of uploaded files\n    http://..../[app]/default/download/[filename]\n    """\n    return response.download(request, db)\n\n\ndef call():\n    """\n    exposes services. for example:\n    http://..../[app]/default/call/jsonrpc\n    decorate with @services.jsonrpc the functions to expose\n    supports xml, json, xmlrpc, jsonrpc, amfrpc, rss, csv\n    """\n    return service()\n\n\n\nresponse._vars=response._caller(add_posts)\n'
p7
sS'snapshot'
p8
(dp9
sS'traceback'
p10
S'Traceback (most recent call last):\n  File "C:\\Users\\Taoh\\Desktop\\git\\Project-cmps183\\web2py\\gluon\\restricted.py", line 227, in restricted\n    exec ccode in environment\n  File "C:\\Users\\Taoh\\Desktop\\git\\Project-cmps183\\web2py\\applications\\cmps183_project\\controllers/default.py", line 295, in <module>\n  File "C:\\Users\\Taoh\\Desktop\\git\\Project-cmps183\\web2py\\gluon\\globals.py", line 412, in <lambda>\n    self._caller = lambda f: f()\n  File "C:\\Users\\Taoh\\Desktop\\git\\Project-cmps183\\web2py\\gluon\\tools.py", line 3774, in f\n    return action(*a, **b)\n  File "C:\\Users\\Taoh\\Desktop\\git\\Project-cmps183\\web2py\\applications\\cmps183_project\\controllers/default.py", line 134, in add_posts\n    if form.process().accepted:\n  File "C:\\Users\\Taoh\\Desktop\\git\\Project-cmps183\\web2py\\gluon\\html.py", line 2301, in process\n    self.validate(**kwargs)\n  File "C:\\Users\\Taoh\\Desktop\\git\\Project-cmps183\\web2py\\gluon\\html.py", line 2238, in validate\n    if self.accepts(**kwargs):\n  File "C:\\Users\\Taoh\\Desktop\\git\\Project-cmps183\\web2py\\gluon\\sqlhtml.py", line 1711, in accepts\n    self.vars.id = self.table.insert(**fields)\n  File "C:\\Users\\Taoh\\Desktop\\git\\Project-cmps183\\web2py\\gluon\\packages\\dal\\pydal\\objects.py", line 712, in insert\n    ret = self._db._adapter.insert(self, self._listify(fields))\n  File "C:\\Users\\Taoh\\Desktop\\git\\Project-cmps183\\web2py\\gluon\\packages\\dal\\pydal\\adapters\\base.py", line 739, in insert\n    raise e\nIntegrityError: foreign key constraint failed\n'
p11
s.